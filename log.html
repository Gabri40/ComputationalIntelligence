<!DOCTYPE html><html><head>
      <title>log</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/gabriquaranta/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.11/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="s318944-gabriele-quaranta---computational-intelligence-activity-log">s318944 Gabriele Quaranta - Computational Intelligence Activity Log </h1>
<h1 id="set-covering">Set Covering </h1>
<h3 id="path-search-studies">Path Search Studies </h3>
<p>The files are in the <code>set-covering-path-search</code> folder. I tried to implement all the techniques learned.</p>
<p>For basic path search the results are in the <code>set_covering_path_search_stats.ipynb</code> file where I tried to implement it with different type of queues to evaluate and learn the difference between them. The main code is the following:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">solve</span><span class="token punctuation">(</span>queuetype<span class="token punctuation">,</span> steps<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Solve the Set Covering problem using different queuing strategies.

    Args:
        queuetype (str): The type of queue to use. Supported values are 'priority', 'simple', or 'lifo'.
        steps (list): A list to store the number of iterations required to solve the problem.
        sets (tuple): A collection of subsets for the Set Covering problem.

    Returns:
        None: The function updates the 'steps' list with the number of iterations needed.
    """</span>
    <span class="token comment"># Initialize the queue based on 'queuetype'</span>
    <span class="token keyword keyword-if">if</span> queuetype <span class="token operator">==</span> <span class="token string">"priority"</span><span class="token punctuation">:</span>
        frontier <span class="token operator">=</span> PriorityQueue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-elif">elif</span> queuetype <span class="token operator">==</span> <span class="token string">"simple"</span><span class="token punctuation">:</span>
        frontier <span class="token operator">=</span> SimpleQueue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-elif">elif</span> queuetype <span class="token operator">==</span> <span class="token string">"lifo"</span><span class="token punctuation">:</span>
        frontier <span class="token operator">=</span> LifoQueue<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Create the initial state representing an empty set of selected subsets</span>
    initial_state <span class="token operator">=</span> State<span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_SET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    frontier<span class="token punctuation">.</span>put<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>

    counter <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword keyword-while">while</span> <span class="token keyword keyword-not">not</span> frontier<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        counter <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token comment"># Get the current state from the queue</span>
        current_state <span class="token operator">=</span> frontier<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Check if the current state is a solution</span>
        <span class="token keyword keyword-if">if</span> goal_check<span class="token punctuation">(</span>current_state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
            steps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>counter<span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span>

        <span class="token comment"># Generate successor states by taking actions (adding subsets)</span>
        <span class="token keyword keyword-for">for</span> action <span class="token keyword keyword-in">in</span> current_state<span class="token punctuation">.</span>not_taken<span class="token punctuation">:</span>
            new_state <span class="token operator">=</span> State<span class="token punctuation">(</span>
                current_state<span class="token punctuation">.</span>taken <span class="token operator">^</span> <span class="token punctuation">{</span>action<span class="token punctuation">}</span><span class="token punctuation">,</span> current_state<span class="token punctuation">.</span>not_taken <span class="token operator">^</span> <span class="token punctuation">{</span>action<span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
            frontier<span class="token punctuation">.</span>put<span class="token punctuation">(</span>new_state<span class="token punctuation">)</span>

    <span class="token comment"># Update the steps list</span>
    steps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>counter<span class="token punctuation">)</span>

    counter <span class="token operator">=</span> <span class="token number">0</span>
</code></pre><p>I the plotted the result for three queuing strategies evaluating the average number of steps for 1000 runs on a problem with 10 subsets and 5 elements:</p>
<ul>
<li>Priority Queue</li>
<li>Simple Queue</li>
<li>LIFO Queue</li>
</ul>
<p>With the Following results:<br>
<img src="image.png" alt="Alt text"></p>
<h3 id="a-search">A* Search </h3>
<p>In the same folder in the files <code>sc_ps_Astar.ipynb</code> and <code>sc_ps_Astar_stats</code> I implemented A* search for the set covering problem. The learing of the topic is in the first file while different tests for the algorithm on differenft problem sizes are in the second. The main code is the following:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">cost</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""The cost function calculates the cost of reaching a particular state"""</span>
    <span class="token keyword keyword-return">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>taken<span class="token punctuation">)</span>


<span class="token keyword keyword-def">def</span> <span class="token function">heuristic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Calculate the number of uncovered elements in U"""</span>
    uncovered <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_not<span class="token punctuation">(</span>
        <span class="token builtin">reduce</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>logical_or<span class="token punctuation">,</span> <span class="token punctuation">[</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>taken<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>PROBLEM_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    remaining_elements <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>uncovered<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> remaining_elements


<span class="token keyword keyword-def">def</span> <span class="token function">astar</span><span class="token punctuation">(</span>sets<span class="token punctuation">,</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Initialize the priority queue with the initial state</span>
    initial_state <span class="token operator">=</span> State<span class="token punctuation">(</span>
        taken<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        cost<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        heuristic<span class="token operator">=</span>heuristic<span class="token punctuation">(</span>State<span class="token punctuation">(</span>taken<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cost<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> heuristic<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    open_set <span class="token operator">=</span> PriorityQueue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    open_set<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span>initial_state<span class="token punctuation">.</span>cost <span class="token operator">+</span> initial_state<span class="token punctuation">.</span>heuristic<span class="token punctuation">,</span> initial_state<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Initialize the closed set as an empty set</span>
    closed_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    checked_states <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword keyword-while">while</span> <span class="token keyword keyword-not">not</span> open_set<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Get the state with the lowest f score from the priority queue</span>
        _<span class="token punctuation">,</span> current_state <span class="token operator">=</span> open_set<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        checked_states <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token comment"># If the current state is a goal state, return the solution</span>
        <span class="token keyword keyword-if">if</span> goal_check<span class="token punctuation">(</span>current_state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
            steps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>checked_states<span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> current_state<span class="token punctuation">.</span>taken


        <span class="token comment"># Add the current state to the closed set</span>
        closed_set<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>current_state<span class="token punctuation">.</span>taken<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Generate successor states by adding one more subset</span>
        <span class="token keyword keyword-for">for</span> subset <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_SET<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> subset <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> current_state<span class="token punctuation">.</span>taken<span class="token punctuation">:</span>
                <span class="token comment"># Create a new state by adding the subset</span>
                new_taken <span class="token operator">=</span> current_state<span class="token punctuation">.</span>taken <span class="token operator">+</span> <span class="token punctuation">[</span>subset<span class="token punctuation">]</span>
                new_cost <span class="token operator">=</span> cost<span class="token punctuation">(</span>State<span class="token punctuation">(</span>new_taken<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                new_heuristic <span class="token operator">=</span> heuristic<span class="token punctuation">(</span>State<span class="token punctuation">(</span>new_taken<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sets<span class="token punctuation">)</span>
                new_state <span class="token operator">=</span> State<span class="token punctuation">(</span>new_taken<span class="token punctuation">,</span> new_cost<span class="token punctuation">,</span> new_heuristic<span class="token punctuation">)</span>

                <span class="token comment"># If the state is not in the closed set, add it to the open set</span>
                <span class="token keyword keyword-if">if</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>new_taken<span class="token punctuation">)</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> closed_set<span class="token punctuation">:</span>
                    open_set<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span>new_state<span class="token punctuation">.</span>cost <span class="token operator">+</span> new_state<span class="token punctuation">.</span>heuristic<span class="token punctuation">,</span> new_state<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># If the open set is empty and no solution is found, return None</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>
</code></pre><p>And the results:</p>
<pre class="language-text">Problem Size: 5
Number of sets: 10
Solvable runs: 88/100
Average number of checked states: 3.45

Problem Size: 20
Number of sets: 80
Solvable runs: 100/100
Average number of checked states:  4.26

Problem Size: 100
Number of sets: 1000
Solvable runs: 100/100
Average number of checked states:  5.99
</pre>
<h3 id="single-state-methods">Single State Methods </h3>
<p>In the folder <code>set-covering-ss</code> I implemented two single state methond to solve the same hill clambing problem as before, Hill Climbing and Simulated annealing.</p>
<p>The problem definition is the same as for path search, the code I develod is the following:</p>
<p><strong>Helper functins and Heuristics</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>  <span class="token keyword keyword-def">def</span> <span class="token function">covered</span><span class="token punctuation">(</span>taken<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword keyword-return">return</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>
          <span class="token builtin">reduce</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>logical_or<span class="token punctuation">,</span> <span class="token punctuation">[</span>SETS<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> taken<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>PROBLEM_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>


  <span class="token keyword keyword-def">def</span> <span class="token function">overlap</span><span class="token punctuation">(</span>taken<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token comment"># spots that are coveredby just one set in take list</span>

      matrix <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>SETS<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> taken<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword keyword-return">return</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>


  <span class="token comment"># heuristic functions</span>
  <span class="token keyword keyword-def">def</span> <span class="token function">h1</span><span class="token punctuation">(</span>taken<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># -&gt; ended up using only h1</span>
      <span class="token comment"># number of spots covered by the union of the sets in state.taken</span>
      <span class="token keyword keyword-return">return</span> covered<span class="token punctuation">(</span>taken<span class="token punctuation">)</span>


  <span class="token keyword keyword-def">def</span> <span class="token function">h2</span><span class="token punctuation">(</span>taken<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token comment"># number of spots covered / number of overlapping spots</span>
      c <span class="token operator">=</span> covered<span class="token punctuation">(</span>taken<span class="token punctuation">)</span>
      o <span class="token operator">=</span> overlap<span class="token punctuation">(</span>taken<span class="token punctuation">)</span>
      <span class="token keyword keyword-return">return</span> c <span class="token operator">/</span> o <span class="token keyword keyword-if">if</span> o <span class="token keyword keyword-else">else</span> c

  <span class="token comment"># successor function</span>
  <span class="token keyword keyword-def">def</span> <span class="token function">successor</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>
        State<span class="token punctuation">(</span>state<span class="token punctuation">.</span>taken <span class="token operator">+</span> <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>cost <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> h1<span class="token punctuation">(</span>state<span class="token punctuation">.</span>taken <span class="token operator">+</span> <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_SET<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> I <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>taken
    <span class="token punctuation">]</span>
</code></pre><p><strong>Hill Climbing</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">hill_climbing</span><span class="token punctuation">(</span>init_state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    current <span class="token operator">=</span> init_state
    pb <span class="token operator">=</span> tqdm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        neighbors <span class="token operator">=</span> successor<span class="token punctuation">(</span>current<span class="token punctuation">)</span>
        <span class="token builtin">next</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>neighbors<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword keyword-lambda">lambda</span> state<span class="token punctuation">:</span> state<span class="token punctuation">.</span>heuristic<span class="token punctuation">)</span>

        pb<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>
            goal_check<span class="token punctuation">(</span>current<span class="token punctuation">)</span>
            <span class="token keyword keyword-or">or</span> <span class="token builtin">next</span><span class="token punctuation">.</span>heuristic <span class="token operator">&lt;</span> current<span class="token punctuation">.</span>heuristic
            <span class="token keyword keyword-or">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>taken<span class="token punctuation">)</span> <span class="token operator">==</span> NUMBER_SET
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> current

        current <span class="token operator">=</span> <span class="token builtin">next</span>
</code></pre><p>With the following results:</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>PROBLEM_SIZE = 500  # dimension of the finite set U
NUMBER_SET = 1000  # number of subsets in the collection S
Found   : State(taken=[177,810,477,442,615,142,95,185,0], cost=9,heuristic=500)
Is sol  : True
Overlap : 439
</code></pre><p><strong>Simulated Annealing</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">simulated_annealing</span><span class="token punctuation">(</span>init_state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    TEMP <span class="token operator">=</span> <span class="token number">20</span>

    current <span class="token operator">=</span> init_state
    pb <span class="token operator">=</span> tqdm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        pb<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> goal_check<span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>taken<span class="token punctuation">)</span> <span class="token operator">==</span> NUMBER_SET<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> current

        neighbors <span class="token operator">=</span> successor<span class="token punctuation">(</span>current<span class="token punctuation">)</span>
        <span class="token builtin">next</span> <span class="token operator">=</span> neighbors<span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>neighbors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        deltaE <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">.</span>heuristic <span class="token operator">-</span> current<span class="token punctuation">.</span>heuristic

        <span class="token keyword keyword-if">if</span> deltaE <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            current <span class="token operator">=</span> <span class="token builtin">next</span>
</code></pre><p>With the following results:</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>PROBLEM_SIZE = 500  # dimension of the finite set U
NUMBER_SET = 1000  # number of subsets in the collection S
Found   : State(taken=[223, 53, 303, 384, 867, 167, 88, 753, 239, 944, 764, 192, 435, 128, 570, 78]
        , cost=16, heuristic=500)
Is sol  : True
Overlap : 488
</code></pre><div style="page-break-after: always"></div>
<h1 id="evolutionary-algorithms">Evolutionary Algorithms </h1>
<p>In the folder <code>evolutionary-algorithms</code> I tried to learn the basics of evolutionary algorithms by solving different problems, after writing a short theory note <code>ES.md</code>.</p>
<p>In all of them I tried to implement and learn the basics of the algorithms while trying different heuristics for the population as well as different types of ES.</p>
<p>The list of problems was given by chatGPT asking for an increament in difficulty each time and is the following:</p>
<h3 id="one-max"><strong>One Max</strong> </h3>
<p>First one with a bit "cheaty" solution where mutation just flips a random bit to one with a certain probability.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>mutated_child <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string">"1"</span> <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> mutation_rate <span class="token keyword keyword-else">else</span> bit <span class="token keyword keyword-for">for</span> bit <span class="token keyword keyword-in">in</span> child<span class="token punctuation">]</span>
<span class="token punctuation">)</span>
new_population<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mutated_child<span class="token punctuation">)</span>
</code></pre><h3 id="knapsack"><strong>KnapSack</strong> </h3>
<p>The second one is the knapsack problem where we have a set of items with a weight and a value and we want to maximize the value of the items we can put in a knapsack with a certain weight limit (Each item with just one copy).<br>
The main takeaway from this problem was the use of different fitness functions.</p>
<p>The first one was just the sum of the values of the items in the knapsack and would set to 0 the fitness of a solution if it were to overshoot capacity, making the solution not take in cosideration for future evolution.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">fitness1</span><span class="token punctuation">(</span>chromosome<span class="token punctuation">)</span><span class="token punctuation">:</span>
    weight <span class="token operator">=</span> <span class="token number">0</span>
    value <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> gene <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>chromosome<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> gene <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            weight <span class="token operator">+=</span> all_items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            value <span class="token operator">+=</span> all_items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-if">if</span> weight <span class="token operator">&gt;</span> BACKPACK_CAPACITY<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">0</span>
    <span class="token keyword keyword-return">return</span> value
</code></pre><p>The second one was the same but trying to give partial credits even to solution the slightly overfit capacity and gave much better results.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">fitness2</span><span class="token punctuation">(</span>chromosome<span class="token punctuation">)</span><span class="token punctuation">:</span>
    weight <span class="token operator">=</span> <span class="token number">0</span>
    value <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> gene <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>chromosome<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> gene <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">:</span>
            weight <span class="token operator">+=</span> all_items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            value <span class="token operator">+=</span> all_items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-if">if</span> weight <span class="token operator">&gt;</span> BACKPACK_CAPACITY<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> value<span class="token operator">/</span><span class="token punctuation">(</span>weight<span class="token operator">-</span>BACKPACK_CAPACITY<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> value
</code></pre><h3 id="tsp"><strong>TSP</strong> </h3>
<p>The TSP is a well-known NP-hard problem, and evolutionary algorithms offer a heuristic approach to finding good solutions when an exhaustive search is impractical for large instances.</p>
<p>The first step for this was using a distance matrix to represent the map.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">generate_distance_matrix</span><span class="token punctuation">(</span>num_cities<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-if">if</span> seed <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>  <span class="token comment"># seed to reproduce res</span>

    <span class="token comment"># empty distance matrix filled with zeros</span>
    distance_matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> num_cities <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_cities<span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment"># random city coordinates</span>
    city_coordinates <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_cities<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_cities<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-for">for</span> j <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> num_cities<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x1<span class="token punctuation">,</span> y1 <span class="token operator">=</span> city_coordinates<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> city_coordinates<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            distance <span class="token operator">=</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
            distance <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span>
            <span class="token comment"># Populate both symmetric elements of the matrix</span>
            distance_matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> distance
            distance_matrix<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> distance

    <span class="token keyword keyword-return">return</span> distance_matri
</code></pre><p>And the fitness function was the sum of the distances between the cities in the order of the chromosome.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">fitness</span><span class="token punctuation">(</span>tour<span class="token punctuation">,</span> distance_matrix<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tour_distance <span class="token operator">=</span> <span class="token number">0</span>
    num_cities <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tour<span class="token punctuation">)</span>

    <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_cities<span class="token punctuation">)</span><span class="token punctuation">:</span>
        from_city <span class="token operator">=</span> tour<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        to_city <span class="token operator">=</span> tour<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> num_cities<span class="token punctuation">]</span>
        tour_distance <span class="token operator">+=</span> distance_matrix<span class="token punctuation">[</span>from_city<span class="token punctuation">]</span><span class="token punctuation">[</span>to_city<span class="token punctuation">]</span>

    <span class="token keyword keyword-return">return</span> tour_distance
</code></pre><p>Parent selection was done using tournament selection and the new population is generated using only mutation where we swap two cities position in the cromosome (so swapping the visit order).</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">reproduce</span><span class="token punctuation">(</span>tournaments_winners<span class="token punctuation">)</span><span class="token punctuation">:</span>
    new_population <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> j <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>POPULATION_SIZE<span class="token punctuation">)</span><span class="token punctuation">:</span>
        child <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>tournaments_winners<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MUTATION_RATE<span class="token punctuation">:</span>
            <span class="token comment"># mutate by swapping two cities</span>
            swap_index1<span class="token punctuation">,</span> swap_index2 <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_CITIES<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            child<span class="token punctuation">[</span>swap_index1<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">[</span>swap_index2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
                child<span class="token punctuation">[</span>swap_index2<span class="token punctuation">]</span><span class="token punctuation">,</span>
                child<span class="token punctuation">[</span>swap_index1<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

        new_population<span class="token punctuation">.</span>append<span class="token punctuation">(</span>child<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> new_population
</code></pre><p>This approach worked pretty well even with a large number of cities (1500).</p>
<h3 id="multy-objective-knapsack"><strong>Multy-Objective KnapSack</strong> </h3>
<p>Last problem in this section, "extends the classic Knapsack Problem by introducing multiple conflicting objectives to optimize simultaneously. This problem is of interest when you have several criteria to consider when selecting items for the knapsack, and these criteria may conflict with each other".</p>
<p>The problem was framed by ChatGPT in a very fun way:</p>
<pre class="language-text">MOKP - Robot Fleet

You are in charge of selecting a team of robots for a space mission. You have a limited energy reserve on your
spacecraft, and you need to decide which robots to take with you.
Each robot has three attributes: energy consumption, repairability, and task completion time.

- Energy Consumption (EC): The amount of energy a robot consumes during the mission.
  Lower values are preferred as they reduce the need for recharging or refueling.

- Repairability (R): A measure of how easily a robot can be repaired if it malfunctions during the mission.
  Higher values indicate greater repairability.

- Task Completion Time (TCT): The time it takes for a robot to complete its assigned tasks.
  Shorter task completion times are preferred for efficiency.

You have a fixed energy reserve (C) for your spacecraft, and you want to maximize the following objectives:

1. Maximize the total repairability (sum of repairability values) of the selected robots.
2. Minimize the total energy consumption (sum of energy consumption values) of the selected robots.
3. Minimize the total task completion time (sum of task completion time values) of the selected robots.

Formally, the Multi-Objective Knapsack Problem can be described as follows:

- Given a set of n robots, each with attributes (EC_i, R_i, TCT_i), where i = 1 to n.
- Given a spacecraft with a energy reserve (C).
- Find a subset of robots to include in the mission that maximizes repairability, minimizes energy consumption,
  and minimizes task completion time, while ensuring that the total energy consumption (sum of EC_i) of the
  selected robots does not exceed the energy reserve (C).
</pre>
<p>The first step was to define the population, the robots are created as named tuples with the three attributes, and an invetory of robots is created with random values for each attribute. The population is the created as a set of binary genomes where each gene represents if a robot from inventory is taken to the ship or not.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># define named tuple for the robot</span>
Robot <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">"Robot"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"ec"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> <span class="token string">"tct"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># build robots inventory</span>
robots <span class="token operator">=</span> <span class="token punctuation">[</span>
    Robot<span class="token punctuation">(</span>
        random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> MAX_EC<span class="token punctuation">)</span><span class="token punctuation">,</span>
        random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> MAX_R<span class="token punctuation">)</span><span class="token punctuation">,</span>
        random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> MAX_TCT<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_ROBOT<span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token comment"># initialize population -&gt; genome is a list of 0 and 1 (genes) (0: robot not selected, 1: robot selected)</span>
population <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_ROBOT<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>POPULATION_SIZE<span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre><p>I then definied two fitness functions, the first one takes the sum of the attributes of the robots in the ship and returns 0 if the total energy overshoots capacity otherwise returns <em>repairability/task completion time</em> since we want to maximize the first and minimize the second.<br>
The second one utilizes weights for each fo the attributes and returns 0 if we overshoot energy or the linear combinations of the weights and total attributes.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># min(sum(ec)), max(sum(r)), min(sum(tct)) while sum(ec) &lt;= ENERGY_RESERVE</span>
<span class="token comment"># maximize reliability and minimize time to task completion and total energy</span>
<span class="token comment">#  -&gt; max(r/tct) while sum(ec) &lt;= ENERGY_RESERVE</span>
<span class="token keyword keyword-def">def</span> <span class="token function">fitness1</span><span class="token punctuation">(</span>genome<span class="token punctuation">)</span><span class="token punctuation">:</span>
    count <span class="token operator">=</span> genome<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    ec <span class="token operator">=</span> <span class="token number">0</span>
    r <span class="token operator">=</span> <span class="token number">0</span>
    tct <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> gene <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>genome<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> gene <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            ec <span class="token operator">+=</span> robots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ec
            r <span class="token operator">+=</span> robots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>r
            tct <span class="token operator">+=</span> robots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tct
    <span class="token comment"># penalize if energy reserve is exceeded or genome is all 0</span>
    <span class="token keyword keyword-if">if</span> ec <span class="token operator">&gt;</span> ENERGY_RESERVE <span class="token keyword keyword-or">or</span> count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">0</span>
    <span class="token keyword keyword-return">return</span> r <span class="token operator">/</span> tct

<span class="token keyword keyword-def">def</span> <span class="token function">fitness2</span><span class="token punctuation">(</span>genome<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># linear combo of weights and vars -&gt; set by trial and error</span>
    W_EC <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5</span>
    W_R <span class="token operator">=</span> <span class="token number">0.3</span>
    W_TCT <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.2</span>

    count <span class="token operator">=</span> genome<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    ec <span class="token operator">=</span> <span class="token number">0</span>
    r <span class="token operator">=</span> <span class="token number">0</span>
    tct <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> gene <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>genome<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> gene <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            ec <span class="token operator">+=</span> robots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ec
            r <span class="token operator">+=</span> robots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>r
            tct <span class="token operator">+=</span> robots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tct

    fitness <span class="token operator">=</span> W_EC <span class="token operator">*</span> ec <span class="token operator">+</span> W_R <span class="token operator">*</span> r <span class="token operator">+</span> W_TCT <span class="token operator">*</span> tct
    <span class="token keyword keyword-if">if</span> ec <span class="token operator">&gt;</span> ENERGY_RESERVE <span class="token keyword keyword-or">or</span> fitness <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">0</span>
    <span class="token keyword keyword-return">return</span> fitness
</code></pre><p>For offspring generation I implemented two different methods, the first one uses both recombination and mutation, the second one only mutation.<br>
The mutation is a bit flip.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">reproduce1</span><span class="token punctuation">(</span>parent1<span class="token punctuation">,</span> parent2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># recombination</span>
    child1 <span class="token operator">=</span> parent1<span class="token punctuation">[</span><span class="token punctuation">:</span> NUMBER_ROBOT <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> parent2<span class="token punctuation">[</span>NUMBER_ROBOT <span class="token operator">//</span> <span class="token number">2</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    child2 <span class="token operator">=</span> parent2<span class="token punctuation">[</span><span class="token punctuation">:</span> NUMBER_ROBOT <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> parent1<span class="token punctuation">[</span>NUMBER_ROBOT <span class="token operator">//</span> <span class="token number">2</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token comment"># mutation</span>
    child1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">-</span> gene <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MUTATION_RATE <span class="token keyword keyword-else">else</span> gene <span class="token keyword keyword-for">for</span> gene <span class="token keyword keyword-in">in</span> child1<span class="token punctuation">]</span>
    child2 <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token number">1</span> <span class="token operator">-</span> gene <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MUTATION_RATE <span class="token keyword keyword-else">else</span> gene <span class="token keyword keyword-for">for</span> gene <span class="token keyword keyword-in">in</span> child2
    <span class="token punctuation">]</span>  <span class="token comment"># chance of mutation ie invert gene</span>

    <span class="token keyword keyword-return">return</span> child1<span class="token punctuation">,</span> child2

<span class="token keyword keyword-def">def</span> <span class="token function">reproduce2</span><span class="token punctuation">(</span>parent1<span class="token punctuation">,</span> parent2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># mutation</span>
    child1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">-</span> gene <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MUTATION_RATE <span class="token keyword keyword-else">else</span> gene <span class="token keyword keyword-for">for</span> gene <span class="token keyword keyword-in">in</span> parent1<span class="token punctuation">]</span>
    child2 <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token number">1</span> <span class="token operator">-</span> gene <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MUTATION_RATE <span class="token keyword keyword-else">else</span> gene <span class="token keyword keyword-for">for</span> gene <span class="token keyword keyword-in">in</span> parent2
    <span class="token punctuation">]</span>  <span class="token comment"># chance of mutation ie invert gene</span>

    <span class="token keyword keyword-return">return</span> child1<span class="token punctuation">,</span> child2
</code></pre><p>I then run the problem for all combinations of the two fitnesses and the two reproduction methods:</p>
<pre class="language-text">fitness1 - reproduce1
Best solution: [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
Total EC     : 1
Mean R /100  : 48.0
Mean TCT /100: 1.0

fitness2  - reproduce1
Best solution: [0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0]
Total EC     : 51
Mean R /100  : 69.75
Mean TCT /100: 14.0

fitness1  - reproduce2
Best solution: [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
Total EC     : 1
Mean R /100  : 48.0
Mean TCT /100: 1.0

fitness2  - reproduce2
Best solution: [0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0]
Total EC     : 55
Mean R /100  : 70.0
Mean TCT /100: 15.4
</pre>
<p>Notably the first fitness functions ends up only choosing one single robot with the highest repairability and the lowest task completion time thus keeping total EC at a minimum, while the second one chooses a more balanced solution.</p>
<div style="page-break-after: always"></div>
<h1 id="labs">LABS </h1>
<h2 id="lab1---set-covering-a">Lab1 - Set Covering A* </h2>
<p>The folder <code>lab1-set-covering-a-star</code> contains the implementation of A* for the set covering problem.</p>
<p>The problem definition is the same as for path search, here I tried to implement various heuristic for the algorithm and compare them. The A* algorithm is a standard implementation using a heap queue for the frontier and a set for the closed set.</p>
<p>The diffent heuristics I tried are the following:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">TRIVIAL_heuristic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span>


<span class="token keyword keyword-def">def</span> <span class="token function">MRSC_heuristic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Minimum Remaining Set Coverage

    This heuristic estimates the cost based on how many elements in "U" are still
    uncovered and divides it by the number of subsets not taken. This heuristic
    assumes that the subsets have an equal chance of covering remaining uncovered
    elements.

    h(state) = (number of uncovered elements in U) / (number of subsets not taken)
    """</span>

    uncovered <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>
        np<span class="token punctuation">.</span>logical_or<span class="token punctuation">,</span> <span class="token punctuation">[</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>taken<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    not_taken_subsets <span class="token operator">=</span> NUMBER_SET <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>taken<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> <span class="token operator">-</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>uncovered<span class="token punctuation">)</span> <span class="token operator">/</span> not_taken_subsets


<span class="token keyword keyword-def">def</span> <span class="token function">MSC_heuristic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Maximum Subset Coverage

    This heuristic estimates the cost by assuming that each additional subset chosen
    will cover as many uncovered elements as possible. It divides the number of
    uncovered elements in "U" by the number of subsets already taken.

    h(state) = (number of uncovered elements in U) / (number of subsets already taken)
    """</span>

    uncovered <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>
        np<span class="token punctuation">.</span>logical_or<span class="token punctuation">,</span> <span class="token punctuation">[</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>taken<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token operator">-</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>uncovered<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>taken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>taken<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword keyword-else">else</span> <span class="token number">0</span>


<span class="token keyword keyword-def">def</span> <span class="token function">MRSC_MSC_heuristic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>MRSC_heuristic<span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span> <span class="token operator">+</span> MSC_heuristic<span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>


<span class="token keyword keyword-def">def</span> <span class="token function">ASC_heuristic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Average Subset Coverage

    This heuristic estimates the cost based on the average size of the remaining
    subsets and assumes that each chosen subset will, on average, cover this many
    elements.

    h(state) = (number of uncovered elements in U) / (average size of remaining subsets)
    """</span>

    uncovered <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>
        np<span class="token punctuation">.</span>logical_or<span class="token punctuation">,</span> <span class="token punctuation">[</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>taken<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    remaining_sets <span class="token operator">=</span> <span class="token punctuation">[</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_SET<span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> I <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>taken<span class="token punctuation">]</span>

    average_size <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> remaining_sets<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>remaining_sets<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> <span class="token operator">-</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>uncovered<span class="token punctuation">)</span> <span class="token operator">/</span> average_size


<span class="token keyword keyword-def">def</span> <span class="token function">RANDOM_heuristic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    !! not admissible but funny !!
    """</span>
    <span class="token keyword keyword-return">return</span> random<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword keyword-def">def</span> <span class="token function">DENSITY_heuristic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Density Heuristic

    This heuristic estimates the cost based on the density of uncovered elements in
    U. It assumes that the subsets have an equal chance of covering remaining
    uncovered elements.

    h(state) = (density of uncovered elements in U) * (number of subsets)
    """</span>

    uncovered <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>
        np<span class="token punctuation">.</span>logical_or<span class="token punctuation">,</span> <span class="token punctuation">[</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> state<span class="token punctuation">.</span>taken<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># Calculate the density of uncovered elements in U</span>
    uncovered_density <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>uncovered<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>uncovered<span class="token punctuation">)</span>

    <span class="token comment"># Estimate the remaining cost based on the uncovered density</span>
    <span class="token keyword keyword-return">return</span> <span class="token operator">-</span>uncovered_density <span class="token operator">*</span> NUMBER_SET
</code></pre><p>For a problem size of 20 and a number of sets of 40 the results are the following:</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>TRIVIAL_heuristic
476it [00:00, 2138.69it/s]3613it [00:01, 2099.28it/s]
 Solution: [1, 14, 37]
 Solution cost: 3
 Solution check: True

MRSC_heuristic
1602it [00:01, 1069.61it/s]
 Solution: [1, 14, 37]
 Solution cost: 3
 Solution check: True

MSC_heuristic
328it [00:00, 1024.68it/s]
 Solution: [1, 14, 37]
 Solution cost: 3
 Solution check: True

MRSC_MSC_heuristic
902it [00:01, 797.65it/s]
 Solution: [1, 14, 37]
 Solution cost: 3
 Solution check: True

ASC_heuristic
18it [00:00, 117.11it/s]
 Solution: [14, 1, 37]
 Solution cost: 3
 Solution check: True

DENSITY_heuristic
5it [00:00, 706.61it/s]
 Solution: [12, 14, 1, 0]
 Solution cost: 4
 Solution check: True

RANDOM_heuristic
5169it [00:02, 2530.52it/s]
 Solution: [14, 33, 37]
 Solution cost: 3
 Solution check: True
</code></pre><p>While almost all get to the optimal solution or very close to one there is a big difference in the amount of iterations needed to get there:</p>
<ul>
<li>The by far best heuristic is the <code>ASC_heuristic</code> with only 18 iterations before finding the best solution.</li>
<li>The <code>DENSITY_heuristic</code> finds a solution in just 5 iterations but it is not the optimal one.</li>
</ul>
<h2 id="lab2---nim-es">LAB2 - Nim ES </h2>
<p>The task involves creating agents to play Nim, a subtraction game where the goal is to avoid taking the last object. The game can have an arbitrary number of rows and a limit on the number of objects that can be removed in a turn.</p>
<p>The code of the lab provided already some functions to choose a move using different strategies (<code>pure_random</code>,<code>gabriele</code>,<code>optimal</code>) as well as a function <code>adaptive</code> to use in the agent.</p>
<p>The way I decided to implement the agent is the following:</p>
<ol>
<li>
<p>The <code>adaptive</code> function uses and updates the parameter <code>love_small</code> to choose the lowest row with the lowest number of objects.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">adaptive1</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> Nim<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Nimply<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""A strategy that can adapt it is parameters"""</span>
    genome <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"love_small"</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">}</span>  <span class="token comment"># set initial value for love_small</span>

    <span class="token keyword keyword-if">if</span> state<span class="token punctuation">.</span>rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">:</span>  <span class="token comment"># if lowest row has 3 or less objects</span>
        genome<span class="token punctuation">[</span><span class="token string">"love_small"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.9</span>  <span class="token comment"># increase love_small</span>
    <span class="token keyword keyword-elif">elif</span> state<span class="token punctuation">.</span>rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">7</span><span class="token punctuation">:</span>  <span class="token comment"># if lowest row has 7 or more objects</span>
        genome<span class="token punctuation">[</span><span class="token string">"love_small"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.1</span>  <span class="token comment"># decrease love_small</span>

    row <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>
        <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword keyword-lambda">lambda</span> r<span class="token punctuation">:</span> state<span class="token punctuation">.</span>rows<span class="token punctuation">[</span>r<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>  <span class="token comment"># select row with lowest number of objects</span>

    num_objects <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>
        genome<span class="token punctuation">[</span><span class="token string">"love_small"</span><span class="token punctuation">]</span> <span class="token operator">*</span> state<span class="token punctuation">.</span>rows<span class="token punctuation">[</span>row<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>  <span class="token comment"># select number of objects to be removed from row</span>

    <span class="token keyword keyword-return">return</span> Nimply<span class="token punctuation">(</span>
        row<span class="token punctuation">,</span> num_objects
    <span class="token punctuation">)</span>  <span class="token comment"># return Nimply object for that row with updated number of objects</span>
</code></pre></li>
<li>
<p>The agent is evolved using a ES algorithm with strategy <strong>(1/3, 1)</strong>:</p>
<ul>
<li>Parent Selection (): The top 1/3 of the population is selected as parents for the subsequent generation.</li>
<li>Reproduction (): It generates one offspring (either by mutation or recombination) per selected parent. This corresponds to the "1" in the (/, ) notation.</li>
<li>Population Update: The algorithm creates a new population by either mutating a randomly selected parent with a certain probability or generating an offspring through reproduction (mating) between randomly chosen parents.</li>
</ul>
</li>
<li>
<p>The agent is definined in the following way:</p>
<ul>
<li>The longest Nim Game is If every player takes exactly one match each turn, so we have a maximum amount of moves an agent can make.</li>
<li>There are 4 strategies to choose a move (the ones above) at each turn.</li>
<li>So we can initialize a population where each agent's genome is a list of strategies (to use consecutively when playing) chosen at random with a weight for each strategy (lower for the optimal one so we do not get just a optimal agent).</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">generate_random_agent_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token comment"># with small change to perform an optimal move</span>
     <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>
         random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span>STRATEGIES<span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
         <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>MAX_NUMBER_MOVES<span class="token punctuation">)</span>
     <span class="token punctuation">]</span>
</code></pre></li>
<li>
<p>The population is evolved using either mutation or crossover for the new offsprings for 200 generations, with a starting population size of 20 and a mutation rate of 0.01, using a fitness function that evaluates the agent against a expert agent for 15 games.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">fitness2</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># plays against expert by exectuing in order the moves of the agent and the expert agent</span>
    <span class="token comment"># fitness is number of matches won by agent with max 10 matches</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span>nim_match<span class="token punctuation">(</span>agent<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>FITNESS_MATCHES<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-return">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> res <span class="token keyword keyword-in">in</span> results<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">mutate</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># swap two move strategies</span>
    <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        swap_index1<span class="token punctuation">,</span> swap_index2 <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>MAX_NUMBER_MOVES<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        agent<span class="token punctuation">[</span>swap_index1<span class="token punctuation">]</span><span class="token punctuation">,</span> agent<span class="token punctuation">[</span>swap_index2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
            agent<span class="token punctuation">[</span>swap_index2<span class="token punctuation">]</span><span class="token punctuation">,</span>
            agent<span class="token punctuation">[</span>swap_index1<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token comment"># change one move strategy to another strategy</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        agent<span class="token punctuation">[</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> MAX_NUMBER_MOVES <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>STRATEGIES<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> agent

<span class="token keyword keyword-def">def</span> <span class="token function">reproduce</span><span class="token punctuation">(</span>agent1<span class="token punctuation">,</span> agent2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># crossover</span>
    <span class="token comment"># random split of the two agents and then concatenate them</span>
    agent1_index <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> MAX_NUMBER_MOVES <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> agent1<span class="token punctuation">[</span><span class="token punctuation">:</span>agent1_index<span class="token punctuation">]</span> <span class="token operator">+</span> agent2<span class="token punctuation">[</span>agent1_index<span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre><pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>POPULATION_SIZE<span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MUTATION_RATE<span class="token punctuation">:</span>
         new_population<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mutate<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>selected_parents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
         agent1 <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>selected_parents<span class="token punctuation">)</span>
         agent2 <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>selected_parents<span class="token punctuation">)</span>
         new_population<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reproduce<span class="token punctuation">(</span>agent1<span class="token punctuation">,</span> agent2<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></li>
<li>
<p>The agent is the evaluated against an agent that chooses always the optimal move for 1000 games, with the following results:</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>!FINAL BOSS!
1000 matches VS EXPERT AGENT
Evolved Agent -&gt; 469 won!
Random Agent  -&gt; 154 won! # for reference
</code></pre></li>
</ol>
<p>We can see that the best agent found has comparable performance to the expert agent (circa 50% win rate) and is much better than a random agent while not always choosing the optimal move.</p>
<h2 id="lab9---genetic-one-sum">LAB9 - Genetic One Sum </h2>
<p>The task involves Write a local-search algorithm (eg. an EA) able to solve the Problem instances 1, 2, 5, and 10 on a 1000-loci genomes, using a minimum number of fitness calls. Seems simple but the fitness function is tricky in that it penalizes following not optimal strategies.</p>
<p>After playing with code for a while using various strategies I noticed that the solutions using the fitness function were saturating to a sort of pattern with length equal to problem istance. For example with problem istance 5 the solutions was plateuing to something like <code>100001000010000...</code> while with istance 2 to <code>1010101010...</code>.</p>
<p>This gave me the idea to allow the algorithm to split the genome in parts with a size that is dependant on the problem istance. This way the algorithm can find the optimal solution for each part and then combine them to get the final solution.</p>
<p>While the fitness function evaluates the whole passed at once the structure of the problem allows for this approach to work. The code is short so it is fully pasted here:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">mutate</span><span class="token punctuation">(</span>ind<span class="token punctuation">,</span> fitness<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""mutate one random gene and return mutated part if fitness is better"""</span>
        f1 <span class="token operator">=</span> fitness<span class="token punctuation">(</span>ind<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> f1 <span class="token operator">==</span> <span class="token number">1.0</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> ind<span class="token punctuation">,</span> f1

        mutated <span class="token operator">=</span> ind<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        I <span class="token operator">=</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">)</span>
        mutated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> mutated<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        f2 <span class="token operator">=</span> fitness<span class="token punctuation">(</span>mutated<span class="token punctuation">)</span>

        <span class="token comment"># mmmmm eugenics</span>
        <span class="token keyword keyword-if">if</span> f2 <span class="token operator">&gt;</span> f1<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> mutated<span class="token punctuation">,</span> f2

        <span class="token keyword keyword-return">return</span> ind<span class="token punctuation">,</span> f1


    <span class="token keyword keyword-def">def</span> <span class="token function">split_progenitor</span><span class="token punctuation">(</span>progenitor<span class="token punctuation">,</span> genome_length<span class="token punctuation">,</span> problem_instance<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""split progenitors in parts of length problem_instance"""</span>
        divisible <span class="token operator">=</span> genome_length <span class="token operator">%</span> problem_instance <span class="token operator">==</span> <span class="token number">0</span>

        end <span class="token operator">=</span> <span class="token punctuation">(</span>
            genome_length <span class="token keyword keyword-if">if</span> divisible <span class="token keyword keyword-else">else</span> genome_length <span class="token operator">-</span> <span class="token punctuation">(</span>genome_length <span class="token operator">%</span> problem_instance<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>  <span class="token comment"># for non-divisible genome_length by problem_instance</span>

        parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> end<span class="token punctuation">,</span> problem_instance<span class="token punctuation">)</span><span class="token punctuation">:</span>
            parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>progenitor<span class="token punctuation">[</span>i <span class="token punctuation">:</span> I <span class="token operator">+</span> problem_instance<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> divisible<span class="token punctuation">:</span>
            parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>progenitor<span class="token punctuation">[</span>end<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> parts


    <span class="token keyword keyword-def">def</span> <span class="token function">run</span><span class="token punctuation">(</span>problem_instance<span class="token punctuation">,</span> genome_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""run the algorithm:
        1. create progenitor
        2. split progenitor in parts
        3. mutate parts until fitness is 1.0
        4. join parts in individual
        5. return number of fitness calls and if individual is correct
        """</span>

        fitness <span class="token operator">=</span> lab9_lib<span class="token punctuation">.</span>make_problem<span class="token punctuation">(</span>problem_instance<span class="token punctuation">)</span>

        progenitor <span class="token operator">=</span> random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token operator">=</span>genome_length<span class="token punctuation">)</span>
        parts <span class="token operator">=</span> split_progenitor<span class="token punctuation">(</span>progenitor<span class="token punctuation">,</span> genome_length<span class="token punctuation">,</span> problem_instance<span class="token punctuation">)</span>

        evolved_parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        pbar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>total<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> part <span class="token keyword keyword-in">in</span> parts<span class="token punctuation">:</span>
            fit <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword keyword-while">while</span> fit <span class="token operator">&lt;</span> <span class="token number">1.0</span><span class="token punctuation">:</span>
                part<span class="token punctuation">,</span> fit <span class="token operator">=</span> mutate<span class="token punctuation">(</span>part<span class="token punctuation">,</span> fitness<span class="token punctuation">)</span>
            evolved_parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>g <span class="token keyword keyword-for">for</span> g <span class="token keyword keyword-in">in</span> part<span class="token punctuation">)</span>
            pbar<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        individual <span class="token operator">=</span> <span class="token punctuation">[</span>gene <span class="token keyword keyword-for">for</span> part <span class="token keyword keyword-in">in</span> evolved_parts <span class="token keyword keyword-for">for</span> gene <span class="token keyword keyword-in">in</span> part<span class="token punctuation">]</span>
        <span class="token keyword keyword-return">return</span> fitness<span class="token punctuation">.</span>calls<span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>individual<span class="token punctuation">)</span> <span class="token operator">==</span> genome_length <span class="token comment"># sum for check it is not used to evaluate fitness</span>
</code></pre><p>With the following results:</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>Problem instance: 1
100%|| 1000/1000 [00:00&lt;00:00, 121701.02it/s]
Calls, solCheck:  (1507, True)

Problem instance: 2
100%|| 500/500 [00:00&lt;00:00, 52313.71it/s]
Calls, solCheck:  (1911, True)

Problem instance: 5
100%|| 200/200 [00:00&lt;00:00, 8916.27it/s]
Calls, solCheck:  (3273, True)

Problem instance: 10
100%|| 100/100 [00:00&lt;00:00, 1858.69it/s]
Calls, solCheck:  (4508, True)
</code></pre><p>Compared to just trying to evolve the whole genome at once the number of fitness calls is much lower as well as the algorithm is able to find a solution for all istances.</p>
<p><strong>Lab 9 No Splitting</strong></p>
<p>I also tried to implement a solution without the above considerations on the structure of the problem by using hill-climbing to evolve the whole genome at once.</p>
<p>The only minor difference is that I used an <em>acceptance_ratio</em> for the fitness of the neighbors to avoid getting stuck in local maxima and promote exploration, thius ratio is set to 1 for istacne 1 and 0.9 for the 2,5,10 istances allowing them to accept slightly worse solutions (this is similar to simulated annealing).</p>
<p>Knowing it would tend to saturate from the previous results I also added a <em>saturation</em> counter to stop the algorithm if it does not find a better solution after 100 iterations.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">generate_neighbor</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span><span class="token punctuation">:</span>
        neighbor <span class="token operator">=</span> solution<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        index_to_flip <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        neighbor<span class="token punctuation">[</span>index_to_flip<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> neighbor<span class="token punctuation">[</span>index_to_flip<span class="token punctuation">]</span>
        <span class="token keyword keyword-return">return</span> neighbor


    <span class="token keyword keyword-def">def</span> <span class="token function">hill_climbing</span><span class="token punctuation">(</span>initial_solution<span class="token punctuation">,</span> problem<span class="token punctuation">,</span> fitness_func<span class="token punctuation">,</span> max_iterations<span class="token punctuation">)</span><span class="token punctuation">:</span>
        current_solution <span class="token operator">=</span> initial_solution
        current_fitness <span class="token operator">=</span> fitness_func<span class="token punctuation">(</span>current_solution<span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> problem <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            acceptance_ratio <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            acceptance_ratio <span class="token operator">=</span> <span class="token number">0.9</span>

        saturation <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_iterations<span class="token punctuation">)</span><span class="token punctuation">:</span>
            neighbor <span class="token operator">=</span> generate_neighbor<span class="token punctuation">(</span>current_solution<span class="token punctuation">)</span>
            neighbor_fitness <span class="token operator">=</span> fitness_func<span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span>

            <span class="token keyword keyword-if">if</span> neighbor_fitness <span class="token operator">&gt;=</span> acceptance_ratio <span class="token operator">*</span> current_fitness<span class="token punctuation">:</span>
                current_solution <span class="token operator">=</span> neighbor
                current_fitness <span class="token operator">=</span> neighbor_fitness
                saturation <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                saturation <span class="token operator">+=</span> <span class="token number">1</span>

            <span class="token keyword keyword-if">if</span> current_fitness <span class="token operator">&gt;=</span> <span class="token number">1.0</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-break">break</span>

            <span class="token keyword keyword-if">if</span> saturation <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token keyword keyword-and">and</span> problem <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">" Saturation at iteration"</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span>
                <span class="token keyword keyword-break">break</span>

        <span class="token keyword keyword-return">return</span> current_solution<span class="token punctuation">,</span> current_fitness
</code></pre><p>With the following results:</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>Problem Instance: 1
 Final Fitness: 1.0
 Fitness Calls: 5926

Problem Instance: 2
 Saturation at iteration 175
 Final Fitness: 0.504
 Fitness Calls: 177

Problem Instance: 5
 Saturation at iteration 1399
 Final Fitness: 0.545
 Fitness Calls: 1401

Problem Instance: 10
 Saturation at iteration 4280
 Final Fitness: 0.53
 Fitness Calls: 4282
</code></pre><h2 id="lab10---tic-tac-toe-agent">LAB10 - Tic-Tac-Toe Agent </h2>
<p>The task involves creating an agent to play Tic-Tac-Toe using a reinforcement algorithm. A random player and the implementation of the game was already provided.The algorithm I decided to use is Q-Learning, a model-free reinforcement learning algorithm that learns to estimate the value of an action in a particular state.</p>
<p>I decided to train 3 different Q-Learing agents, one against random player, one against a minimax player and one against another Q agent.</p>
<p>The minimax agent using classic minimax with a heuristic function that evaluates if the game is won at end of exploration but the score is diminisched with the number of turns taken. Since it is not the focus of the lab the code is in the file but not here.</p>
<p>The Q-Learning agent is implemented using a dictionary for the Q table and a function to update it at each turn, while using epsilon-greedy to choose a move. The code is the following:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">QLearningAgent</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> epsilon<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>epsilon <span class="token operator">=</span> epsilon  <span class="token comment"># Exploration-exploitation trade-off</span>
        self<span class="token punctuation">.</span>alpha <span class="token operator">=</span> alpha  <span class="token comment"># Learning rate</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma  <span class="token comment"># Discount factor</span>

        <span class="token comment"># Q-table: state-action values</span>
        self<span class="token punctuation">.</span>q_table <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">save_q_table</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token operator">=</span><span class="token string">"q_table.pickle"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> f<span class="token punctuation">:</span>
            pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>self<span class="token punctuation">.</span>q_table<span class="token punctuation">,</span> f<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">load_q_table</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token operator">=</span><span class="token string">"q_table.pickle"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> f<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>q_table <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_q_value</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>q_table<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>board<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">choose_move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        available_moves <span class="token operator">=</span> state<span class="token punctuation">.</span>get_available_moves<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>epsilon<span class="token punctuation">:</span>
            <span class="token comment"># Exploration:</span>
            <span class="token keyword keyword-return">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>available_moves<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token comment"># Exploitation:</span>
            q_values <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token punctuation">(</span>action<span class="token punctuation">,</span> self<span class="token punctuation">.</span>get_q_value<span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> action <span class="token keyword keyword-in">in</span> available_moves
            <span class="token punctuation">]</span>
            best_actions <span class="token operator">=</span> <span class="token punctuation">[</span>
                action
                <span class="token keyword keyword-for">for</span> action<span class="token punctuation">,</span> q_value <span class="token keyword keyword-in">in</span> q_values
                <span class="token keyword keyword-if">if</span> q_value <span class="token operator">==</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span>q_value <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> q_value <span class="token keyword keyword-in">in</span> q_values<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
            <span class="token keyword keyword-return">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>best_actions<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">update_q_value</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> next_state<span class="token punctuation">,</span> reward<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Q-value update using the Q-learning formula</span>
        self<span class="token punctuation">.</span>q_table<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>board<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>alpha
        <span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>get_q_value<span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>alpha <span class="token operator">*</span> <span class="token punctuation">(</span>
            reward
            <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma
            <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span>
                <span class="token punctuation">[</span>
                    self<span class="token punctuation">.</span>get_q_value<span class="token punctuation">(</span>next_state<span class="token punctuation">,</span> next_action<span class="token punctuation">)</span>
                    <span class="token keyword keyword-for">for</span> next_action <span class="token keyword keyword-in">in</span> next_state<span class="token punctuation">.</span>get_available_moves<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">play_game</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span>opponent<span class="token punctuation">,</span> environment<span class="token punctuation">,</span>printing<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    environment<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-while">while</span> <span class="token keyword keyword-not">not</span> environment<span class="token punctuation">.</span>is_game_over<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        current_state <span class="token operator">=</span> environment

        <span class="token comment"># Agent Move</span>
        action <span class="token operator">=</span> agent<span class="token punctuation">.</span>choose_move<span class="token punctuation">(</span>current_state<span class="token punctuation">)</span>
        environment<span class="token punctuation">.</span>make_move<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> printing<span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Agent's turn"</span><span class="token punctuation">)</span>
            environment<span class="token punctuation">.</span>print_board<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Check if the game is over</span>
        reward <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword keyword-if">if</span> environment<span class="token punctuation">.</span>is_winner<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            reward <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword keyword-elif">elif</span> environment<span class="token punctuation">.</span>is_winner<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            reward <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> environment<span class="token punctuation">.</span>is_game_over<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            agent<span class="token punctuation">.</span>update_q_value<span class="token punctuation">(</span>current_state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> reward<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> printing<span class="token punctuation">:</span>
                <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Agent wins"</span> <span class="token keyword keyword-if">if</span> reward <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword keyword-else">else</span> <span class="token string">"Tie"</span> <span class="token keyword keyword-if">if</span> reward <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword keyword-else">else</span> <span class="token string">"Opponent wins"</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-break">break</span>

        <span class="token comment"># Opponent Move</span>
        opponent_action <span class="token operator">=</span> opponent<span class="token punctuation">.</span>choose_move<span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
        environment<span class="token punctuation">.</span>make_move<span class="token punctuation">(</span>opponent_action<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> printing<span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Opponent's turn"</span><span class="token punctuation">)</span>
            environment<span class="token punctuation">.</span>print_board<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Check if the game is over</span>
        reward <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword keyword-if">if</span> environment<span class="token punctuation">.</span>is_winner<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            reward <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword keyword-elif">elif</span> environment<span class="token punctuation">.</span>is_winner<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            reward <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> environment<span class="token punctuation">.</span>is_game_over<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            agent<span class="token punctuation">.</span>update_q_value<span class="token punctuation">(</span>current_state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> reward<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> printing<span class="token punctuation">:</span>
                <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Agent wins"</span> <span class="token keyword keyword-if">if</span> reward <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword keyword-else">else</span> <span class="token string">"Tie"</span> <span class="token keyword keyword-if">if</span> reward <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword keyword-else">else</span> <span class="token string">"Opponent wins"</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-break">break</span>

<span class="token comment"># TRAINING</span>
num_episodes <span class="token operator">=</span> <span class="token number">100_000</span>
train<span class="token operator">=</span><span class="token boolean">False</span>
<span class="token comment"># train=True # uncomment/comment to train/not train</span>
<span class="token keyword keyword-if">if</span> train<span class="token punctuation">:</span>
    <span class="token comment"># RANDOM</span>
    agent <span class="token operator">=</span> QLearningAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opponent<span class="token operator">=</span>RandomPlayer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> episode <span class="token keyword keyword-in">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_episodes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        environment <span class="token operator">=</span> TicTacToe<span class="token punctuation">(</span><span class="token punctuation">)</span>
        play_game<span class="token punctuation">(</span>agent<span class="token punctuation">,</span>opponent<span class="token punctuation">,</span> environment<span class="token punctuation">)</span>
    agent<span class="token punctuation">.</span>save_q_table<span class="token punctuation">(</span><span class="token string">"q_table_random.pkl"</span><span class="token punctuation">)</span>

    <span class="token comment"># MINIMAX</span>
    agent <span class="token operator">=</span> QLearningAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opponent<span class="token operator">=</span>MinimaxPlayer<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> episode <span class="token keyword keyword-in">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_episodes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        environment <span class="token operator">=</span> TicTacToe<span class="token punctuation">(</span><span class="token punctuation">)</span>
        play_game<span class="token punctuation">(</span>agent<span class="token punctuation">,</span>opponent<span class="token punctuation">,</span> environment<span class="token punctuation">)</span>
    agent<span class="token punctuation">.</span>save_q_table<span class="token punctuation">(</span><span class="token string">"q_table_minimax.pkl"</span><span class="token punctuation">)</span>

    <span class="token comment"># SELF</span>
    agent <span class="token operator">=</span> QLearningAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opponent<span class="token operator">=</span>QLearningAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> episode <span class="token keyword keyword-in">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_episodes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        environment <span class="token operator">=</span> TicTacToe<span class="token punctuation">(</span><span class="token punctuation">)</span>
        play_game<span class="token punctuation">(</span>agent<span class="token punctuation">,</span>opponent<span class="token punctuation">,</span> environment<span class="token punctuation">)</span>
    agent<span class="token punctuation">.</span>save_q_table<span class="token punctuation">(</span><span class="token string">"q_table_self.pkl"</span><span class="token punctuation">)</span>
</code></pre><p>After training the tree agents for 100_000 episodes I tested them against each other for 100 games each with the following results:</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>RANDOM TRAINED AGENT VS RANDOM
 52 wins
 15 ties
 33 losses

MINIMAX TRAINED AGENT VS MINIMAX
 10 wins
 3 ties
 87 losses

SELF TRAINED AGENT VS SELF
 65 wins
 11 ties
 24 losses

RANDOM TRAINED AGENT VS MINIMAX
 8 wins
 0 ties
 92 losses

RANDOM TRAINED AGENT VS SELF
 55 wins
 16 ties
 29 losses

MINIMAX TRAINED AGENT VS RANDOM
 60 wins
 11 ties
 29 losses

MINIMAX TRAINED AGENT VS SELF
 57 wins
 16 ties
 27 losses

SELF TRAINED AGENT VS RANDOM
 54 wins
 11 ties
 35 losses

SELF TRAINED AGENT VS MINIMAX
 11 wins
 5 ties
 84 losses
</code></pre><p>As expected the minimax agent is the strongest, followed by the Q-Learning agents and finally the random agent.</p>
<div style="page-break-after: always"></div>
<h1 id="peer-reviews">PEER REVIEWS </h1>
<h2 id="lab2---nim-peer-reviews---24112023">LAB2 - Nim Peer Reviews - 24/11/2023 </h2>
<h3 id="httpsgithubcomfedebuccecomputational_intelligence"><a href="https://github.com/FedeBucce/Computational_intelligence/">https://github.com/FedeBucce/Computational_intelligence/</a> </h3>
<pre class="language-text">**Positive Aspects**

Modularity and Readability:
- Use of well-defined functions and classes improves code organization.
- The Individual class encapsulates relevant information

Evolutionary Strategy Implementation:
- The implementation of the (1,) Evolutionary Strategy is clear and follows a standard structure.

Overall the lab seems well implemented 

**Negative Aspects**

Evaluation:
- The agent using adaptive strategies is always player 0, giving it and advantage.
  Starting player could be random for a more fair evaluation.
</pre>
<h3 id="httpsgithubcomallegrarobertocomputational-intelligence"><a href="https://github.com/AllegraRoberto/Computational-Intelligence/">https://github.com/AllegraRoberto/Computational-Intelligence/</a> </h3>
<pre class="language-text">**Positive Aspects**

Documentation:
- Very clear and extensive README allows for clear understanding of the implementation

Modularity and Readability:
- Well-defined functions and comments improves organization and readability

Evaluation:
- Extensive evaluation of the best candidates and comparisons of the results between generations allow
  for a good analysis if the ES used.

Overall the lab seems well implemented 

**Negative Aspects**

Code Repetition:
- Some code within the simulation function is repeated often, could be clearer with some refactoring.

Evaluation:
- The agent using adaptive strategies is always player 0, giving it and advantage.
  Starting player could be random for a more fair evaluation.
</pre>
<h2 id="lab9---peer-reviews---07122023">LAB9 - Peer Reviews - 07/12/2023 </h2>
<h3 id="httpsgithubcomdonatolanzillotticomputational_intelligence23"><a href="https://github.com/DonatoLanzillotti/Computational_Intelligence23">https://github.com/DonatoLanzillotti/Computational_Intelligence23</a> </h3>
<pre class="language-text">**Overall Structure and Organization**
The code is well structured and organized using classes for different components of the evolutionary algorithm.
This makes the code more readable and easy to understand. The plots for the fitness are a nice addition
but the readme could be a bit more extensive.

**EA Implementation**
The EA algorithm has a standard structure with some good improvement like the check of saturation and the
addiction of the already evaluated genomes dict to save computation.

The increase in mutation probability seems to me a bit steep:

    if cnt % 25 == 0 and cnt &gt; 0:
                    self.mutation_prob = self.mutation_prob * 1.25

Given the starting point of .35 and 1.25 multiplayer the probability surpasses 1 after just 5 updates,
but this was maybe by design.

**Final Comments**
Overall the code and the results look good to me!
</pre>
<h3 id="httpsgithubcomahmadrezafrhcomputational-intelligence"><a href="https://github.com/ahmadrezafrh/Computational-Intelligence">https://github.com/ahmadrezafrh/Computational-Intelligence</a> </h3>
<pre class="language-text">**Organization and Structure**
No readme. The code it iself is clear but some comments would help a first glance understanding of what each
component does. The the graphs showing the fitness evolution are a nice addition. 

**Algorithm Implementation**
The algorithm implements correctly a normal EA with some nice additions:
- Switching between mutation and crossover mode if the algo reaches a "patience" limit is a good idea and seems
  to provide a good exploration/exploitation balance
- Early termination based on the amount of the above switches to mutation

The actual algorithm could be implement as a function to avoid cells repetition.

**Final Comments**
Aside some minor organization considerations the code and results look good to me.
</pre>
<h2 id="lab10---peer-reviews--">LAB10 - Peer Reviews - </h2>
<h3 id="httpsgithubcomturymaccomputational-intelligence"><a href="https://github.com/turymac/computational-intelligence">https://github.com/turymac/computational-intelligence</a> </h3>
<pre class="language-text">First of all congratulations on your impressive results!

Given the perfect performance there is not much to say aside some minor considerations:

- the readme could be a bit more extensive on how the code works
- defining a game and player class might make the actual code a bit more readable (but it is already
  pretty nicely commented)

Again this is really good work and well done! 
</pre>
<h3 id="httpsgithubcomkinepoci-polito"><a href="https://github.com/Kinepo/CI-Polito">https://github.com/Kinepo/CI-Polito</a> </h3>
<pre class="language-text">First of all congratulations on the good result, getting your agent to win around 90% of the games!

However the are some organizations issues you should consider:

- structuring the repo with folders and readmes will make it a lot easier to navigate and understand your work
- on the same note adding comments or taking advantage of markdown in the nb will greatly improve the ability
  to understand and follow your code
- no need to have the whole training run print :D

The code itself and the result show a good understanding of DL so there is not much to add,
well done and good luck! 
</pre>
<div style="page-break-after: always"></div>
<h1 id="quixo">QUIXO </h1>
<h3 id="1-introduction">1. Introduction </h3>
<p>The goal of this project is to implement a agent for the game of Quixo.</p>
<p>I tried different approaches, from minimax to a Q-Learning player, ending with a player using Deep Q-Learning with a replay buffer.</p>
<p>Most of the approaches I tried are in the <code>quixo</code> folder aside the very catastrophic ones .</p>
<h2 id="2-the-players">2. The Players </h2>
<h2 id="21-random-player">2.1 Random Player </h2>
<p>Was already implemented in the lab, was used to test the other players.</p>
<h2 id="22-heuristic-player-player">2.2 Heuristic Player Player </h2>
<p>First attempt at implementing an agent based on some simple heuristic after reading the rules of the game and looking at some gameplay online.</p>
<p>This was really bad and it is not commited to the repo.</p>
<p><strong>Main ideas:</strong></p>
<ul>
<li>
<p>At each turn try all the possible moves ( this was achieved by by using a copy and paste version of the __move, __take, __slide as well as a function to find all the possible moves for a certain player)</p>
</li>
<li>
<p>After each try evaluate the board with a simple heuristic function :</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">heuristic</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> board<span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-def">def</span> <span class="token function">count_lines</span><span class="token punctuation">(</span>board<span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># Count the number of lines with 4 pieces of the player ie 4 tiles with value =self.index</span>
            count <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>board<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> player<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">:</span>
                    count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword keyword-if">if</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>board<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">==</span> player<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">:</span>
                    count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword keyword-if">if</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>board<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> player<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">:</span>
                    count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword keyword-if">if</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>board<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> player<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">:</span>
                    count <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword keyword-return">return</span> count

        <span class="token keyword keyword-def">def</span> <span class="token function">count_corners</span><span class="token punctuation">(</span>board<span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># Count the number of corners controlled by the player</span>
            corners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            count <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword keyword-for">for</span> corner <span class="token keyword keyword-in">in</span> corners <span class="token keyword keyword-if">if</span> board<span class="token punctuation">[</span>corner<span class="token punctuation">]</span> <span class="token operator">==</span> player<span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> count

        <span class="token keyword keyword-def">def</span> <span class="token function">center_control</span><span class="token punctuation">(</span>board<span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># Check if the player controls the center of the board</span>
            center <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token number">1</span> <span class="token keyword keyword-if">if</span> board<span class="token punctuation">[</span>center<span class="token punctuation">]</span> <span class="token operator">==</span> player <span class="token keyword keyword-else">else</span> <span class="token number">0</span>

        <span class="token keyword keyword-def">def</span> <span class="token function">edge_control</span><span class="token punctuation">(</span>board<span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># Count the number of edges controlled by the player</span>
            edges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            count <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword keyword-for">for</span> edge <span class="token keyword keyword-in">in</span> edges <span class="token keyword keyword-if">if</span> board<span class="token punctuation">[</span>edge<span class="token punctuation">]</span> <span class="token operator">==</span> player<span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> count

        <span class="token comment"># Calculate the score based on different features</span>
        weights <span class="token operator">=</span> self<span class="token punctuation">.</span>weights
        player <span class="token operator">=</span> self<span class="token punctuation">.</span>index
        score <span class="token operator">=</span> <span class="token punctuation">(</span>
            weights<span class="token punctuation">[</span><span class="token string">"num_lines"</span><span class="token punctuation">]</span> <span class="token operator">*</span> count_lines<span class="token punctuation">(</span>board<span class="token punctuation">,</span> player<span class="token punctuation">)</span>
            <span class="token operator">+</span> weights<span class="token punctuation">[</span><span class="token string">"num_corners"</span><span class="token punctuation">]</span> <span class="token operator">*</span> count_corners<span class="token punctuation">(</span>board<span class="token punctuation">,</span> player<span class="token punctuation">)</span>
            <span class="token operator">+</span> weights<span class="token punctuation">[</span><span class="token string">"center_control"</span><span class="token punctuation">]</span> <span class="token operator">*</span> center_control<span class="token punctuation">(</span>board<span class="token punctuation">,</span> player<span class="token punctuation">)</span>
            <span class="token operator">+</span> weights<span class="token punctuation">[</span><span class="token string">"edge_control"</span><span class="token punctuation">]</span> <span class="token operator">*</span> edge_control<span class="token punctuation">(</span>board<span class="token punctuation">,</span> player<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> score
</code></pre><p><strong>Issues:</strong><br>
I dont think the game of Quixo is suited for a heuristic approach (or rather I just couldn't define a good one): the number of possible moves is high and with the board changing drastically at each turn I found it hard to define a good heuristic.</p>
<p>The result were indistinguishable from just choosing a random action.</p>
<p><strong>Takeaways:</strong></p>
<ul>
<li>Using a copy and paste version of the __move, __take, __slide and most imporantly a function to find all the possible moves for a certain player is a was a good idea and I brought them over to other approaches with refinements.</li>
</ul>
<h2 id="23-q-learning-player">2.3 Q-Learning Player </h2>
<p>After the failure of the heuristic approach I decided to try a reinforcement learning approach after looking at some inspiration online. First time trying to implement a RL algorithm so I was a bit lost at the beginning.<br>
Went over various iterations and rewrites befire getting an understanding of what I was doing adn getting a working player.</p>
<p><strong>Main ideas:</strong></p>
<ul>
<li>
<p>Implementing the Q table as a dictionary with the state as key and the value as the Q value for each action.</p>
</li>
<li>
<p>Before the state and actions are added to the Q table they are transformed to strings (immutable) to be used as key, making sure to tranform the board in a way that is agnostic to the player index (so that the same board is always represented in the same way).</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">board_to_key</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> board<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        transform the board into unique string by concat all the values

        - player1 has index 0
        - player2 has index 1

        example:
            empty board -&gt; '-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1'
        """</span>
        <span class="token comment"># need to make the key agnostic to the player index so we can use it for</span>
        <span class="token comment"># both players</span>

        <span class="token comment"># can train the player as player 0 if the player is player 1, we need to</span>
        <span class="token comment"># invert the board =&gt; just invert the key ???</span>

        board_str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> board <span class="token keyword keyword-for">for</span> x <span class="token keyword keyword-in">in</span> row<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>player_index <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            board_str <span class="token operator">=</span> board_str<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> board_str

    <span class="token keyword keyword-def">def</span> <span class="token function">move_to_key</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Move<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        transform the move into unique string by concat all the values

        example: # ((0, 0), Move.TOP) -&gt; '000'
        """</span>
        row <span class="token operator">=</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        col <span class="token operator">=</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        move_value <span class="token operator">=</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value
        <span class="token keyword keyword-return">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>col<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>move_value<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">movekey_to_move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> movekey<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Move<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        transform the movekey string into move

        example: '000' -&gt; ((0, 0), Move.TOP)
        """</span>
        row <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>movekey<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        col <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>movekey<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        move_value <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>movekey<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span><span class="token punctuation">,</span> Move<span class="token punctuation">(</span>move_value<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">add_new_board</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        add new board and all possible actions to the q table
        """</span>
        board_key <span class="token operator">=</span> self<span class="token punctuation">.</span>board_to_key<span class="token punctuation">(</span>game<span class="token punctuation">.</span>_board<span class="token punctuation">)</span>
        all_action_keys <span class="token operator">=</span> <span class="token punctuation">[</span>
            self<span class="token punctuation">.</span>move_to_key<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> action <span class="token keyword keyword-in">in</span> get_all_possible_actions<span class="token punctuation">(</span>game<span class="token punctuation">,</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>q_table<span class="token punctuation">[</span>board_key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-for">for</span> action_key <span class="token keyword keyword-in">in</span> all_action_keys<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>q_table<span class="token punctuation">[</span>board_key<span class="token punctuation">]</span><span class="token punctuation">[</span>action_key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_max_q_value_move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        return move with max q value for the current board
        """</span>
        board_key <span class="token operator">=</span> self<span class="token punctuation">.</span>board_to_key<span class="token punctuation">(</span>game<span class="token punctuation">.</span>_board<span class="token punctuation">)</span>
        max_q_value <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>q_table<span class="token punctuation">[</span>board_key<span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        max_q_value_moves <span class="token operator">=</span> <span class="token punctuation">[</span>
            self<span class="token punctuation">.</span>movekey_to_move<span class="token punctuation">(</span>movekey<span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> movekey<span class="token punctuation">,</span> q_value <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>q_table<span class="token punctuation">[</span>board_key<span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> q_value <span class="token operator">==</span> max_q_value
        <span class="token punctuation">]</span>
        <span class="token keyword keyword-return">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>max_q_value_moves<span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>Epson greedy approach is used to choose the action to take</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token keyword keyword-def">def</span> <span class="token function">make_move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Move<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        exploration vs exploitation

        chance to make a random move or the move with max q value
        """</span>
        current_board_key <span class="token operator">=</span> self<span class="token punctuation">.</span>board_to_key<span class="token punctuation">(</span>game<span class="token punctuation">.</span>_board<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> current_board_key <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>q_table<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>add_new_board<span class="token punctuation">(</span>game<span class="token punctuation">)</span>

        action <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>random_action_probability<span class="token punctuation">:</span>
            action <span class="token operator">=</span> get_random_possible_action<span class="token punctuation">(</span>game<span class="token punctuation">,</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> self<span class="token punctuation">.</span>get_max_q_value_move<span class="token punctuation">(</span>game<span class="token punctuation">)</span>

        action_key <span class="token operator">=</span> self<span class="token punctuation">.</span>move_to_key<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> action_key <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>q_table<span class="token punctuation">[</span>current_board_key<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"action key not in q table but it shuld be"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>last_game_actions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>current_board_key<span class="token punctuation">,</span> action_key<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre></li>
<li>
<p>The Q values are updated at the end of each game based of the win or lose.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>  <span class="token keyword keyword-def">def</span> <span class="token function">update_q_table</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> haswon<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">"""
      update q table after the game is finished
      """</span>
      <span class="token keyword keyword-if">if</span> haswon<span class="token punctuation">:</span>
          <span class="token keyword keyword-for">for</span> board_key<span class="token punctuation">,</span> action_key <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>last_game_actions<span class="token punctuation">:</span>
              self<span class="token punctuation">.</span>q_table<span class="token punctuation">[</span>board_key<span class="token punctuation">]</span><span class="token punctuation">[</span>action_key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
      <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
          <span class="token keyword keyword-for">for</span> board_key<span class="token punctuation">,</span> action_key <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>last_game_actions<span class="token punctuation">:</span>
              self<span class="token punctuation">.</span>q_table<span class="token punctuation">[</span>board_key<span class="token punctuation">]</span><span class="token punctuation">[</span>action_key<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span>

      self<span class="token punctuation">.</span>last_game_actions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></li>
</ul>
<p><strong>Issues:</strong></p>
<p>While I can see it working with enough compute the main issue is the size of the Q table: the number of possible states is huge and the Q table grows exponentially with the number of games played.</p>
<p>After training for 100_000 games the Q table was already 400MB and the player while improving was still not much better than a random player.</p>
<p>Q table is not commited for size reasons.</p>
<p><strong>Takeaways:</strong></p>
<ul>
<li>
<p>Most important takeaway is making the board agnostic to the player index which I didn't do before as well as converting the board adn actions to a more compact representation (will be useful later when finally implementing DQL).</p>
</li>
<li>
<p>The Q table was a good idea but the size of it is a problem.</p>
</li>
<li>
<p>I created an <code>utils.py</code> file to store all the functions like getting all the possible actions and trying a move.</p>
</li>
</ul>
<h2 id="24-minimax-player">2.4 Minimax Player </h2>
<p>Tried my hand at a minimax player using alpha beta pruning. Like with the heuristic player I found it hard to define a good heuristic for the game of Quixo.</p>
<p><strong>Main ideas:</strong></p>
<ul>
<li>
<p>Standard Minimax with alpha beta pruning</p>
</li>
<li>
<p>Using the same functions as before to get all the possible moves and try them while evaluating with a "new" heuristic function</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>  <span class="token keyword keyword-def">def</span> <span class="token function">mid_game_heuristic</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> board<span class="token punctuation">)</span><span class="token punctuation">:</span>
      boardeval <span class="token operator">=</span> <span class="token number">0</span>

      <span class="token comment"># max number in a row col or diag for each player</span>
      mp<span class="token punctuation">,</span> mo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
      <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
          mp <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>mp<span class="token punctuation">,</span> np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>board<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
          mo <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>mo<span class="token punctuation">,</span> np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>board<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
          mp <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>mp<span class="token punctuation">,</span> np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>board<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
          mo <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>mo<span class="token punctuation">,</span> np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>board<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mp <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>mp<span class="token punctuation">,</span> np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>board<span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mo <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>mo<span class="token punctuation">,</span> np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>board<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span><span class="token punctuation">)</span>

      boardeval <span class="token operator">+=</span> <span class="token number">5</span><span class="token operator">**</span>mp <span class="token operator">-</span> <span class="token number">5</span><span class="token operator">**</span>mo

      <span class="token comment"># piece count</span>
      cp <span class="token operator">=</span> np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>board<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span>
      op <span class="token operator">=</span> np<span class="token punctuation">.</span>count_nonzero<span class="token punctuation">(</span>board<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>player_index<span class="token punctuation">)</span>
      boardeval <span class="token operator">+=</span> <span class="token number">2</span><span class="token operator">**</span>cp <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">**</span>op

      <span class="token comment"># # Core count</span>
      <span class="token comment"># for I in range(1, 4):</span>
      <span class="token comment">#     for j in range(1, 4):</span>
      <span class="token comment">#         boardeval += (</span>
      <span class="token comment">#             1</span>
      <span class="token comment">#             if board[i][j] == self.player_index</span>
      <span class="token comment">#             else -1</span>
      <span class="token comment">#             if board[i][j] == 1 - self.player_index</span>
      <span class="token comment">#             else 0</span>
      <span class="token comment">#         )</span>

      <span class="token comment"># Edge count</span>
      edge_positions <span class="token operator">=</span> <span class="token punctuation">(</span>
          <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
          <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
          <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
          <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> I <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
      <span class="token keyword keyword-for">for</span> x<span class="token punctuation">,</span> y <span class="token keyword keyword-in">in</span> edge_positions<span class="token punctuation">:</span>
          boardeval <span class="token operator">+=</span> <span class="token punctuation">(</span>
              <span class="token number">2</span>
              <span class="token keyword keyword-if">if</span> board<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>player_index
              <span class="token keyword keyword-else">else</span> <span class="token operator">-</span><span class="token number">2</span>
              <span class="token keyword keyword-if">if</span> board<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>player_index
              <span class="token keyword keyword-else">else</span> <span class="token number">0</span>
          <span class="token punctuation">)</span>

      <span class="token comment"># # Corner count</span>
      <span class="token comment"># corner_positions = [(0, 0), (0, 4), (4, 0), (4, 4)]</span>
      <span class="token comment"># for x, y in corner_positions:</span>
      <span class="token comment">#     boardeval += (</span>
      <span class="token comment">#         1</span>
      <span class="token comment">#         if board[x][y] == self.player_index</span>
      <span class="token comment">#         else -1</span>
      <span class="token comment">#         if board[x][y] == 1 - self.player_index</span>
      <span class="token comment">#         else 0</span>
      <span class="token comment">#     )</span>

      <span class="token keyword keyword-return">return</span> boardeval
</code></pre></li>
</ul>
<p><strong>Issues:</strong><br>
While the algorithm works I still had issues trying to find a combination things to consider and the weights for them in the heuristic function that would make the player play well.</p>
<p>Again it was winning only slightly more than a random player.</p>
<p><strong>Takeaways:</strong><br>
Doing some research online I found some informations:</p>
<ul>
<li>
<p>Quixo is a solved game ()[] but with exponential complexity ()[]. I couldn't however follow the implementation of the algorithm in the paper.</p>
</li>
<li>
<p>The structure of the game can leading to repeating patterns and this can hinder performance of a minimax algorithm. I dont doubt hoever that my implementation of it and heuristic function were not good enough to reach this limitations. However after getting these informations I decided to move to Deep Q-Learning.</p>
</li>
</ul>
<h2 id="25-deep-q-learning-player">2.5 Deep Q-Learning Player </h2>
<p>Final player implemented, it took some time to understand how to implement it and I had to rewrite it many times bifore getting an understanding of what I was doing.</p>
<p>The main struggle I faced was trying to understand how to read and evalualte the output of the network after giving it the current state as well as how to evaluate the loss and update the network.</p>
<p>The complete dql player code is also copied all at once at the end of the log.</p>
<p><strong>Main ideas:</strong></p>
<ul>
<li>
<p>Experience and Replay Buffer: at each step the player saves the current state, action, reward and next state in a replay buffer. This is used to train the network at the end of each game. The main ideas behind the Replay Buffer are the following:</p>
<ul>
<li>The network is trained at the end of each game with a batch of random samples from the replay buffer. This is done to avoid the network overfitting on only the last moves of the game.</li>
<li>It helps mitigate instabilities and allow the network to learn from previous experiences.</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>Experience <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">"Experience"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span> <span class="token string">"action"</span><span class="token punctuation">,</span> <span class="token string">"next_state"</span><span class="token punctuation">,</span> <span class="token string">"reward"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">ReplayBuffer</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100_000</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">=</span> deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>max_size<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> experience<span class="token punctuation">:</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>experience<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>Conversion of the board to a neutral representation agnostic to the player index as well as converting the actions to a more compact representation.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">board_to_neutral_flatten_board</span><span class="token punctuation">(</span>board<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p_index<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""Converts a board to a neutral flatten board where current player is 1, opponent is -1 and empty is 0"""</span>
  opponent <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> p_index
  <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>
      <span class="token number">1</span> <span class="token keyword keyword-if">if</span> x <span class="token operator">==</span> p_index <span class="token keyword keyword-else">else</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword keyword-if">if</span> x <span class="token operator">==</span> opponent <span class="token keyword keyword-else">else</span> <span class="token number">0</span> <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> board <span class="token keyword keyword-for">for</span> x <span class="token keyword keyword-in">in</span> row
  <span class="token punctuation">]</span>

<span class="token keyword keyword-def">def</span> <span class="token function">reward_to_neutral_reward</span><span class="token punctuation">(</span>reward<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> p_index<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""Converts a reward to a neutral reward where current player is 1, opponent is -1 else 0"""</span>
  <span class="token keyword keyword-if">if</span> reward <span class="token operator">==</span> p_index<span class="token punctuation">:</span>
  <span class="token keyword keyword-return">return</span> <span class="token number">1</span>
  <span class="token keyword keyword-elif">elif</span> reward <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">-</span> p_index<span class="token punctuation">:</span>
  <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
  <span class="token keyword keyword-return">return</span> <span class="token number">0.5</span>

</code></pre></li>
<li>
<p>The model is a pytorch neural network with the following structure.</p>
<ul>
<li>The input will be the flattened board converted to a neutral representation</li>
<li>The output will be a 4*5*5 tensor. So it will be viewed as a 4 5*5 matrices. Each matrix corresponds to one of the move directions (TOP, BOTTOM, LEFT, RIGHT) and each cell of the matrix will contain the Q value for that move in that position.</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>  <span class="token keyword keyword-class">class</span> <span class="token class-name">DQN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> output_dim<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
          <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
          self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
          self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
          self<span class="token punctuation">.</span>fc3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> output_dim<span class="token punctuation">)</span>

      <span class="token keyword keyword-def">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
          x <span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
          x <span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>fc3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>The models output a Q value for every cell and for every move but not all of them are possible (either illegal or the board configuration does not allow it). To account for this the output tensor is first converted to the (4,5,5) view described above before being masked with a mask created from all the possible actions at the current turn. Then the indices of the action with the highest Q value are taken and converted to a valid move format. The whole process is done with the following functions inside the player class:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">get_model_output</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Returns the model output for the current game board"""</span>
    state <span class="token operator">=</span> board_to_neutral_flatten_board<span class="token punctuation">(</span>game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>state<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">model_output_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Returns the model output for the current game board reshaped to 4 5x5 matrices one matrix per slide direction"""</span>
    <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>get_model_output<span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">mask_model_output</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Mask the model output to only possible actions"""</span>
    model_output <span class="token operator">=</span> self<span class="token punctuation">.</span>get_model_output<span class="token punctuation">(</span>game<span class="token punctuation">)</span>
    model_output <span class="token operator">=</span> model_output<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

    possible_actions <span class="token operator">=</span> all_possible_actions_to_list_triplets<span class="token punctuation">(</span>game<span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span>
    possible_actions_to_model_output_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-for">for</span> action <span class="token keyword keyword-in">in</span> possible_actions<span class="token punctuation">:</span>
        possible_actions_to_model_output_mask<span class="token punctuation">[</span>action<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword keyword-return">return</span> model_output <span class="token operator">*</span> possible_actions_to_model_output_mask

<span class="token keyword keyword-def">def</span> <span class="token function">get_max_q_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Returns indexes of the action with the highest q value"""</span>
    <span class="token comment"># masked 4 * [5 * 5] matrix</span>
    masked_model_output <span class="token operator">=</span> self<span class="token punctuation">.</span>mask_model_output<span class="token punctuation">(</span>game<span class="token punctuation">)</span>

    <span class="token comment"># Find the index of the maximum value across all matrices</span>
    flat_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>masked_model_output<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Calculate matrix, row, and column indices directly</span>
    matrix_index <span class="token operator">=</span> flat_index <span class="token operator">//</span> <span class="token punctuation">(</span>
        masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    row_index <span class="token operator">=</span> <span class="token punctuation">(</span>
        flat_index <span class="token operator">%</span> <span class="token punctuation">(</span>masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token operator">//</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    col_index <span class="token operator">=</span> <span class="token punctuation">(</span>
        flat_index <span class="token operator">%</span> <span class="token punctuation">(</span>masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token operator">%</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>row_index<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> col_index<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matrix_index<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">action_to_move</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Move<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Converts an action triplet to a move"""</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Move<span class="token punctuation">(</span>action<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>At each turn the move is chosen with an epsilon greedy approach and the experience is added to a current game buffer.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">add_experience</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">,</span>
    action<span class="token punctuation">:</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Adds an experience to the memory"""</span>
    state <span class="token operator">=</span> board_to_neutral_flatten_board<span class="token punctuation">(</span>game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span>
    next_state <span class="token operator">=</span> board_to_neutral_flatten_board<span class="token punctuation">(</span>
        utils<span class="token punctuation">.</span>try_move<span class="token punctuation">(</span>self<span class="token punctuation">.</span>action_to_move<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">,</span> game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>p_index<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    reward <span class="token operator">=</span> reward_to_neutral_reward<span class="token punctuation">(</span>
        utils<span class="token punctuation">.</span>evaluate_winner<span class="token punctuation">(</span>game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index
    <span class="token punctuation">)</span>
    experience <span class="token operator">=</span> Experience<span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> next_state<span class="token punctuation">,</span> reward<span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>one_game_memory<span class="token punctuation">.</span>append<span class="token punctuation">(</span>experience<span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">make_move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Move<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Makes a move eps greedy"""</span>
    <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> utils<span class="token punctuation">.</span>get_random_possible_action<span class="token punctuation">(</span>game<span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> self<span class="token punctuation">.</span>get_max_q_action<span class="token punctuation">(</span>game<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add_experience<span class="token punctuation">(</span>game<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        action <span class="token operator">=</span> self<span class="token punctuation">.</span>action_to_move<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

    action <span class="token operator">=</span> <span class="token punctuation">(</span>action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># GOD WHY</span>
    <span class="token keyword keyword-return">return</span> action
</code></pre></li>
<li>
<p>For the training loop the theplayer plays a number of games against a random player and at the end of each game the current game buffer is added to the replay buffer. If the replay buffer has enough memories (to avoid overfitting the first matches) it is sampled and the network is updated on the samples using MSE loss and Adam optimizer.:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_games<span class="token operator">=</span><span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Trains the model"""</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Training..."</span><span class="token punctuation">)</span>
        <span class="token builtin">buffer</span> <span class="token operator">=</span> ReplayBuffer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> g <span class="token keyword keyword-in">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_games<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            game <span class="token operator">=</span> Game<span class="token punctuation">(</span><span class="token punctuation">)</span>
            p1 <span class="token operator">=</span> DQLPlayer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            p2 <span class="token operator">=</span> RandomPlayer<span class="token punctuation">(</span><span class="token punctuation">)</span>
            res <span class="token operator">=</span> game<span class="token punctuation">.</span>play<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
            neutral_result <span class="token operator">=</span> reward_to_neutral_reward<span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token keyword keyword-for">for</span> m <span class="token keyword keyword-in">in</span> p1<span class="token punctuation">.</span>get_memories<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                e <span class="token operator">=</span> Experience<span class="token punctuation">(</span>
                    m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> m<span class="token punctuation">.</span>action<span class="token punctuation">,</span> m<span class="token punctuation">.</span>next_state<span class="token punctuation">,</span> m<span class="token punctuation">.</span>reward <span class="token operator">-</span> neutral_result
                <span class="token punctuation">)</span>
                <span class="token builtin">buffer</span><span class="token punctuation">.</span>push<span class="token punctuation">(</span>e<span class="token punctuation">)</span>

            batch_size <span class="token operator">=</span> <span class="token number">64</span>
            <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> batch_size<span class="token punctuation">:</span>
                <span class="token keyword keyword-continue">continue</span>

            experiences <span class="token operator">=</span> <span class="token builtin">buffer</span><span class="token punctuation">.</span>sample<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>

            states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>state <span class="token keyword keyword-for">for</span> e <span class="token keyword keyword-in">in</span> experiences<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
            actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>action <span class="token keyword keyword-for">for</span> e <span class="token keyword keyword-in">in</span> experiences<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
            next_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>
                <span class="token punctuation">[</span>e<span class="token punctuation">.</span>next_state <span class="token keyword keyword-for">for</span> e <span class="token keyword keyword-in">in</span> experiences<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32
            <span class="token punctuation">)</span>
            rewards <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>reward <span class="token keyword keyword-for">for</span> e <span class="token keyword keyword-in">in</span> experiences<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

            current_q_values <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

            next_q_values <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>next_states<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
            target_q_values <span class="token operator">=</span> rewards <span class="token operator">+</span> <span class="token number">0.99</span> <span class="token operator">*</span> next_q_values
            target_q_values <span class="token operator">=</span> target_q_values<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

            loss <span class="token operator">=</span> self<span class="token punctuation">.</span>loss<span class="token punctuation">(</span>current_q_values<span class="token punctuation">,</span> target_q_values<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></li>
</ul>
<p><strong>Issues:</strong><br>
Many Deep Q Learnig implementations use a target network to avoid the network overfitting on the last moves of the game while this does not.</p>
<p><strong>Takeaways:</strong><br>
The network is able to beat a random player more than 80% of the times on average both as first and second player.</p>
<pre class="language-text"># DQNPlayer as P1 - Win rate over 1000 games: 0.838
# DQNPlayer as P2 - Win rate over 1000 games: 0.797

# DQNPlayer as P1 - Win rate over 1000 games: 0.836
# DQNPlayer as P2 -  Win rate over 1000 games: 0.804

# DQNPlayer as P1 - Win rate over 1000 games: 0.852
# DQNPlayer as P2 -  Win rate over 1000 games: 0.806
</pre>
<p>These results are obtained after trainging the player for 1000 games with the replay buffer and the value of epsilon for the greedy choice is 0.1 .</p>
<p>Given the decisely worse performance of the other players I implemented I consider this a good result and don't think it is necessary to implement evaluation against them as well as implementing a target network.</p>
<p>This seems the best approach given both the results and the structure of the game it iself.</p>
<div style="page-break-after: always"></div>
<h1 id="final-dql-player">Final DQL Player </h1>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> utils
<span class="token keyword keyword-import">import</span> torch
<span class="token keyword keyword-import">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword keyword-as">as</span> nn
<span class="token keyword keyword-import">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword keyword-as">as</span> optim
<span class="token keyword keyword-import">import</span> numpy <span class="token keyword keyword-as">as</span> np
<span class="token keyword keyword-import">import</span> random
<span class="token keyword keyword-from">from</span> game <span class="token keyword keyword-import">import</span> Game<span class="token punctuation">,</span> Move<span class="token punctuation">,</span> Player
<span class="token keyword keyword-from">from</span> collections <span class="token keyword keyword-import">import</span> namedtuple
<span class="token keyword keyword-from">from</span> tqdm <span class="token keyword keyword-import">import</span> tqdm
<span class="token keyword keyword-from">from</span> collections <span class="token keyword keyword-import">import</span> deque


<span class="token keyword keyword-class">class</span> <span class="token class-name">RandomPlayer</span><span class="token punctuation">(</span>Player<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">make_move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Move<span class="token punctuation">]</span><span class="token punctuation">:</span>
        from_pos <span class="token operator">=</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        move <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span>Move<span class="token punctuation">.</span>TOP<span class="token punctuation">,</span> Move<span class="token punctuation">.</span>BOTTOM<span class="token punctuation">,</span> Move<span class="token punctuation">.</span>LEFT<span class="token punctuation">,</span> Move<span class="token punctuation">.</span>RIGHT<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> from_pos<span class="token punctuation">,</span> move


Experience <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">"Experience"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span> <span class="token string">"action"</span><span class="token punctuation">,</span> <span class="token string">"next_state"</span><span class="token punctuation">,</span> <span class="token string">"reward"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword keyword-class">class</span> <span class="token class-name">ReplayBuffer</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> capacity<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10_000</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">=</span> deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>capacity<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">push</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> experience<span class="token punctuation">:</span> Experience<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>experience<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span>Experience<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>


<span class="token keyword keyword-def">def</span> <span class="token function">board_to_neutral_flatten_board</span><span class="token punctuation">(</span>board<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p_index<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Converts a board to a neutral flatten board where current player is 1, opponent is -1 and empty is 0"""</span>
    opponent <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> p_index
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>
        <span class="token number">1</span> <span class="token keyword keyword-if">if</span> x <span class="token operator">==</span> p_index <span class="token keyword keyword-else">else</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword keyword-if">if</span> x <span class="token operator">==</span> opponent <span class="token keyword keyword-else">else</span> <span class="token number">0</span> <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> board <span class="token keyword keyword-for">for</span> x <span class="token keyword keyword-in">in</span> row
    <span class="token punctuation">]</span>


<span class="token keyword keyword-def">def</span> <span class="token function">all_possible_actions_to_list_triplets</span><span class="token punctuation">(</span>
    game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">,</span> p_index
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Converts a list of possible actions for the current to a list of tuple of int"""</span>
    actions <span class="token operator">=</span> utils<span class="token punctuation">.</span>get_all_possible_actions<span class="token punctuation">(</span>game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p_index<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> action <span class="token keyword keyword-in">in</span> actions<span class="token punctuation">]</span>


<span class="token keyword keyword-def">def</span> <span class="token function">reward_to_neutral_reward</span><span class="token punctuation">(</span>reward<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> p_index<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Converts a reward to a neutral reward where current player is 1, opponent is -1 else 0"""</span>
    <span class="token keyword keyword-if">if</span> reward <span class="token operator">==</span> p_index<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">1</span>
    <span class="token keyword keyword-elif">elif</span> reward <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">-</span> p_index<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">0.5</span>


<span class="token keyword keyword-class">class</span> <span class="token class-name">DQN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> output_dim<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> output_dim<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>fc3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>


<span class="token keyword keyword-class">class</span> <span class="token class-name">DQLPlayer</span><span class="token punctuation">(</span>Player<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Deep Q Learning Player.

    Parameters:

    - p_index: The player index.
    - preload: Whether to preload the model from a file. (default: False)

    Choose the action using epsilon greedy.

    The model is a DQN with 25 input neurons and 4 * 5 * 5 output neurons.

    The input neurons are the 25 board positions, 1 if the position is the
    current player, -1 if the position is the opponent, 0 otherwise.

    The output neurons are the 4 possible actions for each of the 5x5 board

    The model is trained using a replay buffer.
    """</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p_index<span class="token punctuation">,</span> preload<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>p_index <span class="token operator">=</span> p_index
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> DQN<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token comment"># 25 * 4actions, needs a mask</span>
        <span class="token comment"># should return 4 5x5 matrices each matrix is q values for each move</span>

        <span class="token keyword keyword-if">if</span> preload<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"quixo/dqlmodel.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>one_game_memory <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"quixo/dqlmodel.pt"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Saves the model to a file"""</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_memories</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span>Experience<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Returns the memories of the last game"""</span>
        <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>one_game_memory

    <span class="token keyword keyword-def">def</span> <span class="token function">get_model_output</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Returns the model output for the current game board"""</span>
        state <span class="token operator">=</span> board_to_neutral_flatten_board<span class="token punctuation">(</span>game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>state<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">model_output_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Returns the model output for the current game board reshaped to 4 5x5 matrices one matrix per slide direction"""</span>
        <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>get_model_output<span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">mask_model_output</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Mask the model output to only possible actions"""</span>
        model_output <span class="token operator">=</span> self<span class="token punctuation">.</span>get_model_output<span class="token punctuation">(</span>game<span class="token punctuation">)</span>
        model_output <span class="token operator">=</span> model_output<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

        possible_actions <span class="token operator">=</span> all_possible_actions_to_list_triplets<span class="token punctuation">(</span>game<span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span>
        possible_actions_to_model_output_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-for">for</span> action <span class="token keyword keyword-in">in</span> possible_actions<span class="token punctuation">:</span>
            possible_actions_to_model_output_mask<span class="token punctuation">[</span>action<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>

        <span class="token keyword keyword-return">return</span> model_output <span class="token operator">*</span> possible_actions_to_model_output_mask

    <span class="token keyword keyword-def">def</span> <span class="token function">get_max_q_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Returns indexes of the action with the highest q value"""</span>
        <span class="token comment"># masked 4 * [5 * 5] matrix</span>
        masked_model_output <span class="token operator">=</span> self<span class="token punctuation">.</span>mask_model_output<span class="token punctuation">(</span>game<span class="token punctuation">)</span>

        <span class="token comment"># Find the index of the maximum value across all matrices</span>
        flat_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>masked_model_output<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Calculate matrix, row, and column indices directly</span>
        matrix_index <span class="token operator">=</span> flat_index <span class="token operator">//</span> <span class="token punctuation">(</span>
            masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        row_index <span class="token operator">=</span> <span class="token punctuation">(</span>
            flat_index <span class="token operator">%</span> <span class="token punctuation">(</span>masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token operator">//</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        col_index <span class="token operator">=</span> <span class="token punctuation">(</span>
            flat_index <span class="token operator">%</span> <span class="token punctuation">(</span>masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token operator">%</span> masked_model_output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

        <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>row_index<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> col_index<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matrix_index<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">action_to_move</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Move<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Converts an action triplet to a move"""</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Move<span class="token punctuation">(</span>action<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">add_experience</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">,</span>
        action<span class="token punctuation">:</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Adds an experience to the memory"""</span>
        state <span class="token operator">=</span> board_to_neutral_flatten_board<span class="token punctuation">(</span>game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span>
        next_state <span class="token operator">=</span> board_to_neutral_flatten_board<span class="token punctuation">(</span>
            utils<span class="token punctuation">.</span>try_move<span class="token punctuation">(</span>self<span class="token punctuation">.</span>action_to_move<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">,</span> game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>p_index<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        reward <span class="token operator">=</span> reward_to_neutral_reward<span class="token punctuation">(</span>
            utils<span class="token punctuation">.</span>evaluate_winner<span class="token punctuation">(</span>game<span class="token punctuation">.</span>get_board<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index
        <span class="token punctuation">)</span>
        experience <span class="token operator">=</span> Experience<span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> next_state<span class="token punctuation">,</span> reward<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>one_game_memory<span class="token punctuation">.</span>append<span class="token punctuation">(</span>experience<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">make_move</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> game<span class="token punctuation">:</span> <span class="token string">"Game"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Move<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Makes a move eps greedy"""</span>
        <span class="token keyword keyword-if">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> utils<span class="token punctuation">.</span>get_random_possible_action<span class="token punctuation">(</span>game<span class="token punctuation">,</span> self<span class="token punctuation">.</span>p_index<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> self<span class="token punctuation">.</span>get_max_q_action<span class="token punctuation">(</span>game<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>add_experience<span class="token punctuation">(</span>game<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
            action <span class="token operator">=</span> self<span class="token punctuation">.</span>action_to_move<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

        action <span class="token operator">=</span> <span class="token punctuation">(</span>action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-return">return</span> action

    <span class="token keyword keyword-def">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_games<span class="token operator">=</span><span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Trains the model"""</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Training..."</span><span class="token punctuation">)</span>
        <span class="token builtin">buffer</span> <span class="token operator">=</span> ReplayBuffer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> g <span class="token keyword keyword-in">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_games<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            game <span class="token operator">=</span> Game<span class="token punctuation">(</span><span class="token punctuation">)</span>
            p1 <span class="token operator">=</span> DQLPlayer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            p2 <span class="token operator">=</span> RandomPlayer<span class="token punctuation">(</span><span class="token punctuation">)</span>
            res <span class="token operator">=</span> game<span class="token punctuation">.</span>play<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
            neutral_result <span class="token operator">=</span> reward_to_neutral_reward<span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token keyword keyword-for">for</span> m <span class="token keyword keyword-in">in</span> p1<span class="token punctuation">.</span>get_memories<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                e <span class="token operator">=</span> Experience<span class="token punctuation">(</span>
                    m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> m<span class="token punctuation">.</span>action<span class="token punctuation">,</span> m<span class="token punctuation">.</span>next_state<span class="token punctuation">,</span> m<span class="token punctuation">.</span>reward <span class="token operator">-</span> neutral_result
                <span class="token punctuation">)</span>
                <span class="token builtin">buffer</span><span class="token punctuation">.</span>push<span class="token punctuation">(</span>e<span class="token punctuation">)</span>

            batch_size <span class="token operator">=</span> <span class="token number">64</span>
            <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> batch_size<span class="token punctuation">:</span>
                <span class="token keyword keyword-continue">continue</span>

            experiences <span class="token operator">=</span> <span class="token builtin">buffer</span><span class="token punctuation">.</span>sample<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>

            states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>state <span class="token keyword keyword-for">for</span> e <span class="token keyword keyword-in">in</span> experiences<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
            actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>action <span class="token keyword keyword-for">for</span> e <span class="token keyword keyword-in">in</span> experiences<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
            next_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>
                <span class="token punctuation">[</span>e<span class="token punctuation">.</span>next_state <span class="token keyword keyword-for">for</span> e <span class="token keyword keyword-in">in</span> experiences<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32
            <span class="token punctuation">)</span>
            rewards <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>reward <span class="token keyword keyword-for">for</span> e <span class="token keyword keyword-in">in</span> experiences<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

            current_q_values <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

            next_q_values <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>next_states<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
            target_q_values <span class="token operator">=</span> rewards <span class="token operator">+</span> <span class="token number">0.99</span> <span class="token operator">*</span> next_q_values
            target_q_values <span class="token operator">=</span> target_q_values<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

            loss <span class="token operator">=</span> self<span class="token punctuation">.</span>loss<span class="token punctuation">(</span>current_q_values<span class="token punctuation">,</span> target_q_values<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># player = DQLPlayer(0, preload=False)</span>
    <span class="token comment"># player.train()</span>

    games <span class="token operator">=</span> <span class="token number">100</span>
    wins <span class="token operator">=</span> <span class="token number">0</span>
    p1 <span class="token operator">=</span> DQLPlayer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    p2 <span class="token operator">=</span> RandomPlayer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>games<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        game <span class="token operator">=</span> Game<span class="token punctuation">(</span><span class="token punctuation">)</span>
        res <span class="token operator">=</span> game<span class="token punctuation">.</span>play<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            wins <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Win rate: </span><span class="token interpolation"><span class="token punctuation">{</span>wins<span class="token operator">/</span>games<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

</code></pre>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>